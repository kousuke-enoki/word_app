name: CDK deploy

on:
  push:
    branches: [main]
    paths:
      - "backend/**"
      - "infra/**"
      - ".github/workflows/**"

concurrency:
  group: cdk-deploy-${{ github.ref_name }}
  cancel-in-progress: true

jobs:
  build_push:
    runs-on: ubuntu-latest
    permissions: { contents: read, id-token: write }
    outputs:
      image_digest: ${{ steps.get_digest.outputs.digest }}
    steps:
      - uses: actions/checkout@v4

      - uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-region: ap-northeast-1
          # role-to-assume: arn:aws:iam::<ACCOUNT_ID>:role/<GITHUB_OIDC_ROLE>
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}

      - uses: aws-actions/amazon-ecr-login@v2
      - uses: docker/setup-buildx-action@v3

      - name: Build & push Lambda image (:lambda)
        run: |
          docker build -f backend/Lambda.Dockerfile \
            -t ${{ secrets.ECR_REPO }}:lambda backend
          docker push ${{ secrets.ECR_REPO }}:lambda

      - name: Get pushed digest
        id: get_digest
        run: |
          REPO_NAME=$(echo "${{ secrets.ECR_REPO }}" | awk -F'/' '{print $2}')
          DIGEST=$(aws ecr describe-images \
            --repository-name "$REPO_NAME" \
            --image-ids imageTag=lambda \
            --query 'imageDetails[0].imageDigest' --output text)
          echo "digest=$DIGEST" >> $GITHUB_OUTPUT

  cdk_deploy:
    needs: build_push
    runs-on: ubuntu-latest
    permissions: { contents: read, id-token: write }
    env:
      CDK_APP: "npx ts-node infra/bin/myapp.ts"
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with: { node-version: 20 }
      - run: npm ci --prefix infra

      - uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-region: ap-northeast-1
          # role-to-assume: arn:aws:iam::<ACCOUNT_ID>:role/<GITHUB_OIDC_ROLE>
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}

      - name: CDK Deploy (pin digest)
        run: |
          npx cdk deploy --app "$CDK_APP" --all \
            -c imageDigest=${{ needs.build_push.outputs.image_digest }} \
            --require-approval never

  post_k6_staging:
    name: Post-deploy k6 (A + light B)
    needs: cdk_deploy
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
      - uses: grafana/setup-k6-action@v1
      - uses: actions/setup-node@v4
        with: { node-version: 22 }

      - name: Install bench tool deps
        run: npm --prefix bench ci

      - uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-region: ap-northeast-1
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}

      - name: Probe: show BASE_URL and resolve CFN Api URL
        id: probe
        env:
          BASE_URL: ${{ secrets.STG_BASE_URL }}
        run: |
          set -eu
          echo "BASE_URL from secrets: ${BASE_URL:-<empty>}"
          CFN_URL=$(aws cloudformation describe-stacks \
            --stack-name AppStack \
            --query "Stacks[0].Outputs[?OutputKey=='ApiUrl'].OutputValue | [0]" \
            --output text 2>/dev/null || echo "")
          echo "CFN_URL from CloudFormation: ${CFN_URL:-<empty>}"
          # どちらを使うか決定（STG_BASE_URL 未設定/誤設定の保険）
          USE_URL="${BASE_URL:-$CFN_URL}"
          if [ -z "$USE_URL" ]; then
            echo "::error::Both BASE_URL and CFN_URL are empty"
            exit 1
          fi
          echo "use_url=$USE_URL" >> $GITHUB_OUTPUT
          echo "Using URL: $USE_URL"

      - name: Warm-up & echo headers
        env:
          USE_URL: ${{ steps.probe.outputs.use_url }}
        run: |
          set -eu
          test -n "$USE_URL"
          echo "=== GET $USE_URL/health ==="
          curl -sv "$USE_URL/health" 2>&1 || true
          echo ""
          echo "=== POST $USE_URL/users/auth/test-login ==="
          curl -sv -X POST \
            -H "content-type: application/json" \
            "$USE_URL/users/auth/test-login" \
            -d '{}' 2>&1 || true

      - name: Warm-up staging (optional but recommended)
        env:
          USE_URL: ${{ steps.probe.outputs.use_url }}
        run: |
          for i in {1..5}; do curl -sf "$USE_URL/health" || true; sleep 1; done

      - name: Run A-layer smoke on staging
        env:
          BASE_URL: ${{ steps.probe.outputs.use_url }}
          ALLOW_WRITE: "false"
        run: |
          set -eu
          mkdir -p bench/k6/out
          if [ -z "${BASE_URL:-}" ]; then
            echo "::error::BASE_URL is empty"
            exit 1
          fi
          test -f bench/k6/a/smoke_all.js || { echo "::error::k6 script not found: bench/k6/a/smoke_all.js"; exit 1; }
          k6 run --summary-export=bench/k6/out/smoke_stg.json bench/k6/a/smoke_all.js

      - name: Run B-layer (search only, PR profile)
        env:
          BASE_URL: ${{ steps.probe.outputs.use_url }}
          PROFILE: pr
        run: |
          set -eu
          if [ -z "${BASE_URL:-}" ]; then
            echo "::error::BASE_URL is empty"
            exit 1
          fi
          test -f bench/k6/b/search_words.js || { echo "::error::k6 script not found: bench/k6/b/search_words.js"; exit 1; }
          k6 run --summary-export=bench/k6/out/b_search_stg.json bench/k6/b/search_words.js

      - name: Make charts (optional)
        run: |
          node bench/tools/mkcharts.js bench/k6/out/b_search_stg.json bench/k6/out/search_rps_p95.html || true

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: k6-staging-post-deploy
          path: |
            bench/k6/out/**
          retention-days: 7
