name: CDK deploy

on:
  push:
    branches: [main]
    paths:
      - "backend/**"
      - "infra/**"
      - ".github/workflows/**"

concurrency:
  group: cdk-deploy-${{ github.ref_name }}
  cancel-in-progress: true

jobs:
  build_push:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write
    outputs:
      image_digest: ${{ steps.get_digest.outputs.digest }}
    steps:
      - uses: actions/checkout@v4

      - uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-region: ap-northeast-1
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}

      - uses: aws-actions/amazon-ecr-login@v2
      - uses: docker/setup-buildx-action@v3

      - name: Build & push Lambda image (:lambda)
        run: |
          docker build -f backend/Lambda.Dockerfile \
            -t ${{ secrets.ECR_REPO }}:lambda backend
          docker push ${{ secrets.ECR_REPO }}:lambda

      - name: Get pushed digest
        id: get_digest
        run: |
          REPO_NAME=$(echo "${{ secrets.ECR_REPO }}" | awk -F'/' '{print $2}')
          DIGEST=$(aws ecr describe-images \
            --repository-name "$REPO_NAME" \
            --image-ids imageTag=lambda \
            --query "imageDetails[0].imageDigest" --output text)
          echo "digest=$DIGEST" >> "$GITHUB_OUTPUT"

  cdk_deploy:
    needs: build_push
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write
    env:
      CDK_APP: "npx ts-node infra/bin/myapp.ts"
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 20
      - run: npm ci --prefix infra

      - uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-region: ap-northeast-1
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}

      - name: CDK Deploy (pin digest)
        run: |
          npx cdk deploy --app "$CDK_APP" --all \
            -c imageDigest=${{ needs.build_push.outputs.image_digest }} \
            --require-approval never

  post_k6_staging:
    name: Post-deploy k6 (A + light B)
    needs: cdk_deploy
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write
    env:
      CF_APP_STACK: AppStack
    steps:
      - uses: actions/checkout@v4
      - uses: grafana/setup-k6-action@v1
      - uses: actions/setup-node@v4
        with:
          node-version: 22

      - uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-region: ap-northeast-1
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}

      - name: Install bench tool deps
        run: npm --prefix bench ci

      - name: Resolve BASE_URL (secret > CFN Output: ApiUrl)
        id: resolve_base_url
        shell: bash
        run: |
          set -eu
          if [ -n "${{ secrets.STG_BASE_URL }}" ]; then
            BASE_URL="${{ secrets.STG_BASE_URL }}"
          else
            echo "::notice::secrets.STG_BASE_URL is empty. Resolving from CloudFormation outputs..."
            BASE_URL="$(aws cloudformation describe-stacks \
              --stack-name "$CF_APP_STACK" \
              --query "Stacks[0].Outputs[?OutputKey=='ApiUrl'].OutputValue" \
              --output text || true)"
          fi
          if [ -z "${BASE_URL}" ] || [ "${BASE_URL}" = "None" ]; then
            echo "::error::Could not resolve BASE_URL. Set secrets.STG_BASE_URL or add ApiUrl output to $CF_APP_STACK"
            exit 1
          fi
          BASE_URL="${BASE_URL%/}"
          echo "BASE_URL=${BASE_URL}" >> "$GITHUB_ENV"
          echo "Resolved BASE_URL=${BASE_URL}"

      - name: Wait for /health (HTTP 200, retry)
        shell: bash
        run: |
          set -eu
          url="${BASE_URL}/health"
          echo "Probing: ${url}"
          for i in $(seq 1 30); do
            code=$(curl -sS -o /dev/null -w "%{http_code}" "${url}" || echo "000")
            echo "Attempt $i: status=${code}"
            if [ "${code}" = "200" ]; then
              echo "Health OK"
              exit 0
            fi
            sleep 3
          done
          echo "::error::/health did not become 200 within timeout"
          curl -i "${url}" || true
          exit 1

      - name: Probe /users/auth/test-login (accept 200 or 429)
        shell: bash
        run: |
          set -eu
          url="${BASE_URL}/users/auth/test-login"
          echo "Probing: ${url}"
          for i in $(seq 1 10); do
            code=$(curl -sS -o /tmp/tl.json -w "%{http_code}" -X POST \
              -H "content-type: application/json" \
              -d '{}' "${url}" || echo "000")
            echo "Attempt $i: status=${code}"
            if [ "${code}" = "200" ] || [ "${code}" = "429" ]; then
              echo "test-login OK (status=${code})"
              cat /tmp/tl.json || true
              exit 0
            fi
            sleep 3
          done
          echo "::error::test-login stayed non-OK (wanted 200/429)"
          echo "Last response:"
          cat /tmp/tl.json || true
          exit 1

      - name: Warm-up staging (optional)
        env:
          BASE_URL: ${{ env.BASE_URL }}
        run: |
          for i in {1..5}; do curl -sf "$BASE_URL/health" || true; sleep 1; done

      - name: Run A-layer smoke on staging
        env:
          BASE_URL: ${{ env.BASE_URL }}
          ALLOW_WRITE: "false"
        run: |
          set -eu
          mkdir -p bench/k6/out
          test -f bench/k6/a/smoke_all.js || { echo "::error::k6 script not found: bench/k6/a/smoke_all.js"; exit 1; }
          k6 run --summary-export=bench/k6/out/smoke_stg.json bench/k6/a/smoke_all.js

      - name: Run B-layer (search only, PR profile)
        env:
          BASE_URL: ${{ env.BASE_URL }}
          PROFILE: pr
        run: |
          set -eu
          test -f bench/k6/b/search_words.js || { echo "::error::k6 script not found: bench/k6/b/search_words.js"; exit 1; }
          k6 run --summary-export=bench/k6/out/b_search_stg.json bench/k6/b/search_words.js

      - name: Make charts (optional)
        run: |
          node bench/tools/mkcharts.js bench/k6/out/b_search_stg.json bench/k6/out/search_rps_p95.html || true

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: k6-staging-post-deploy
          path: |
            bench/k6/out/**
          retention-days: 7
