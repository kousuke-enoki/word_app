# ---------- base build stage ----------
FROM golang:1.24.3 AS build-base
WORKDIR /src

COPY go.mod go.sum ./
RUN go mod download

COPY . .

# ---------- production build ----------
FROM build-base AS prod-build
RUN CGO_ENABLED=0 go build -o /out/server      ./cmd/server && \
    CGO_ENABLED=0 go build -o /out/import_dict ./cmd/import_dict

# ---------- linter stage ----------
FROM golangci/golangci-lint:v2.3.0 AS lint

# ---------- development (hot‑reload) ----------
FROM golang:1.24.3 AS dev
WORKDIR /app
# air をインストール
RUN go install entgo.io/ent/cmd/ent@latest \
 && go install github.com/air-verse/air@latest


COPY --from=build-base /src .

# ★ 生成ステップを追加
RUN go generate ./ent
#   もしくは  ↓
# RUN ent generate ./ent/schema --feature sql/execquery,sql/upsert

# Air の設定ファイルがあれば一緒にコピー
COPY .air.toml .
ENTRYPOINT ["air"]

# ---------- production runtime ----------
FROM busybox:uclibc AS prod
WORKDIR /app
COPY --from=prod-build /out/* /usr/local/bin/
ENTRYPOINT ["/usr/local/bin/server"]
